<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.innovate.cms.modules.qs.dao.sns.QxMatchDao">
	
	<select id="get" resultType="QxMatch">
		
	</select>
	
	<select id="findList" resultType="QxMatch">
		
	</select>
	
	<select id="findAllList" resultType="QxMatch">
		
	</select>
	
	
	<insert id="insert">
		
	</insert>
	
	<select id="getChatBoxMatch" resultType="com.innovate.cms.modules.data.entity.ChatBoxMatchToJson">
		SELECT d1.templateTag, d1.groupName, d1.results
			FROM (SELECT c1.templateTag, c1.groupName, c1.results, c1.create_time
				FROM (SELECT '5' AS "templateTag", b2.group_name AS "groupName", ROUND(b1.num / b2.gidCount, 2) AS "results", b2.create_time
					FROM (SELECT a2.gid, a2.num
						FROM (SELECT a1.gid, a1.c, COUNT(a1.c) AS "num"
							FROM (SELECT qha1.gid, qha1.answer - qha2.answer AS "c"
								FROM qx_history_answer qha1, qx_history_answer qha2
								WHERE qha1.uid = #{fromUid}
									AND qha2.uid = #{toUid}
									AND qha1.gid = qha2.gid
									AND qha1.qid = qha2.qid
								) a1
							GROUP BY a1.gid, a1.c
							) a2
						WHERE a2.c = '0'
						) b1, (SELECT qh1.gid, COUNT(qh1.gid) AS "gidCount", qg.group_name, qh1.create_time
							FROM qx_history qh1, qx_history qh2, qx_groups qg, qx_questions ques
							WHERE qh1.template_tag = '5'
								AND qh1.gid = qh2.gid
								AND qh1.uid = #{fromUid}
								AND qh2.uid = #{toUid}
								AND qh1.template_tag = qh2.template_tag
								AND qh1.gid = qg.gid
								AND qh1.gid = ques.gid
								AND qh1.del_flag = '0'
								AND qh2.del_flag = qh1.del_flag
							GROUP BY qh1.gid
							) b2
					WHERE b1.gid = b2.gid
					) c1
				WHERE c1.results > #{range}
				UNION
				SELECT qh1.template_tag AS "templateTag", qg.group_name AS "groupName", qh2.results AS "results", qh1.create_time
				FROM qx_history qh1, qx_history qh2, qx_groups qg
				WHERE qh1.uid = #{fromUid}
					AND qh2.uid = #{toUid}
					AND qh1.template_tag = '4'
					AND qh2.template_tag = qh1.template_tag
					AND qh1.gid = qh2.gid
					AND qh1.results_tag = qh2.results_tag
					AND qg.gid = qh1.gid
					AND qh1.del_flag = '0'
					AND qh1.del_flag = qh2.del_flag
				) d1
			ORDER BY d1.create_time DESC
			LIMIT 0, #{limit}
	</select>
	
	
	<select id="isExisth5t4" resultType="int">
		SELECT
			count(1)
		FROM
			qx_match_h5
		WHERE
			gid = #{gid}
		AND my_uid = #{myUid}
		AND follow_uid = #{followUid}
	</select>
	
	
	<update id="updateMatchResh5t4">
		UPDATE qx_match_h5
		SET title = #{results}
		WHERE
			gid = #{gid}
		AND my_uid = #{myUid}
		AND follow_uid = #{followUid}
	</update>
	
	<insert id="addNewMatchh5t4">
		INSERT INTO `qx_match_h5` (
			`gid`,
			`my_unionid`,
			`my_uid`,
			`my_img`,
			`my_name`,
			`follow_unionid`,
			`follow_uid`,
			`follow_img`,
			`follow_name`,
			`match_result`,
			`zone_content`,
			`title`,
			`create_time`
		) SELECT
			a1.gid,
			a1.my_unionid,
			a1.my_uid,
			a1.my_img,
			a1.my_name,
			a1.follow_unionid,
			a1.follow_uid,
			a1.follow_img,
			a1.follow_name,
			0,
			"",
			#{results},
			NOW() AS "create_time"
		FROM
			(
				SELECT
					#{gid} AS "gid",
					u1.unionid AS "my_unionid",
					u1.uid AS "my_uid",
					u1.headimgurl AS "my_img",
					u1.`nickname` AS "my_name",
					u2.unionid AS "follow_unionid",
					u2.uid AS "follow_uid",
					u2.headimgurl AS "follow_img",
					u2.nickname AS "follow_name"
				FROM
					system_user AS u1,
					system_user AS u2
				WHERE
					u1.uid = #{myUid}
				AND u2.uid =  #{followUid}
			) a1
	
	</insert>
	
	<insert id="addNewMatch">
		INSERT INTO `qx_match`(
			`gid`,
			`my_unionid`,
			`my_uid`,
			`my_img`,
			`my_name`,
			`follow_unionid`,
			`follow_uid`,
			`follow_img`,
			`follow_name`,
			`match_result`,
			`zone_content`,
			`create_time`
		)
		VALUES
			(
				#{gid},
				#{myUnionid},
				#{myUid},
				#{myImg},
				#{myName},
				#{followUnionid},
				#{followUid},
				#{followImg},
				#{followName},
				#{matchResult},
				#{zoneContent},
				#{createTime}
			);
	</insert>
	
	<insert id="addNewMatch2">
		INSERT INTO `qx_match` (
			`gid`,
			`my_unionid`,
			`my_uid`,
			`my_img`,
			`my_name`,
			`follow_unionid`,
			`follow_uid`,
			`follow_img`,
			`follow_name`,
			`match_result`,
			`zone_content`,
			`title`,
			`create_time`
		) SELECT
			a1.gid,
			a1.my_unionid,
			a1.my_uid,
			a1.my_img,
			a1.my_name,
			a1.follow_unionid,
			a1.follow_uid,
			a1.follow_img,
			a1.follow_name,
			a1.match_result,
			qz.zone_content,
			qz.title,
			NOW() AS "create_time"
		FROM
			(
				SELECT
					#{gid} AS "gid",
					qf.unionid AS "my_unionid",
					qf.uid AS "my_uid",
					qf.img AS "my_img",
					qf.`name` AS "my_name",
					qf.follow_unionid AS "follow_unionid",
					qf.follow_uid AS "follow_uid",
					qf.follow_img AS "follow_img",
					qf.follow_name AS "follow_name",
					#{matchResult} AS 'match_result',
					ROUND(#{matchResult}, 1) AS 'num'
				FROM
					qx_follow AS qf
				WHERE
					qf.uid = #{myUid}
				AND qf.follow_uid = #{followUid}
				AND NOT EXISTS (
					SELECT
						'x'
					FROM
						(
							SELECT
								a1.my_uid,
								a1.follow_uid,
								a1.gid
							FROM
								qx_match AS a1
							WHERE
								a1.my_uid = #{myUid}
							AND a1.follow_uid = #{followUid}
							AND a1.gid = #{gid}
						UNION ALL
							SELECT
								a2.follow_uid AS "my_uid",
								a2.my_uid AS "follow_uid",
								a2.gid
							FROM
								qx_match AS a2
							WHERE
								a2.my_uid = #{followUid}
							AND a2.follow_uid = #{myUid}
							AND a2.gid = #{gid}
						) b1
					WHERE
						(b1.my_uid = qf.uid AND b1.follow_uid = qf.follow_uid)
					OR  (b1.follow_uid = qf.uid AND b1.my_uid = qf.follow_uid)
				)
			) a1,
			qx_zone_answer AS qa,
			qx_zone AS qz
		WHERE
			a1.gid = qa.gid
		AND qa.zone_type = qz.zone_type
		AND a1.num = qz.zone
	</insert>
	<insert id="addNewMatchStranger">
		INSERT INTO `qx_match_stranger` (
			`gid`,
			`my_unionid`,
			`my_uid`,
			`my_img`,
			`my_name`,
			`follow_unionid`,
			`follow_uid`,
			`follow_img`,
			`follow_name`,
			`match_result`,
			`zone_content`,
			`title`,
			`create_time`
		) SELECT
			a1.gid,
			a1.my_unionid,
			a1.my_uid,
			a1.my_img,
			a1.my_name,
			a1.follow_unionid,
			a1.follow_uid,
			a1.follow_img,
			a1.follow_name,
			a1.match_result,
			qz.zone_content,
			qz.title,
			NOW() AS "create_time"
		FROM
			(
				SELECT
					#{gid} AS "gid",
					qf.unionid AS "my_unionid",
					qf.uid AS "my_uid",
					qf.img AS "my_img",
					qf.`name` AS "my_name",
					qf.follow_unionid AS "follow_unionid",
					qf.follow_uid AS "follow_uid",
					qf.follow_img AS "follow_img",
					qf.follow_name AS "follow_name",
					#{matchResult} AS 'match_result',
					ROUND(#{matchResult}, 1) AS 'num'
				FROM
					qx_follow AS qf
				WHERE
					qf.uid = #{myUid}
				AND qf.follow_uid = #{followUid}
				AND NOT EXISTS (
					SELECT
						'x'
					FROM
						(
							SELECT
								a1.my_uid,
								a1.follow_uid,
								a1.gid
							FROM
								qx_match_stranger AS a1
							WHERE
								a1.my_uid = #{myUid}
							AND a1.follow_uid = #{followUid}
							AND a1.gid = #{gid}
						UNION ALL
							SELECT
								a2.follow_uid AS "my_uid",
								a2.my_uid AS "follow_uid",
								a2.gid
							FROM
								qx_match_stranger AS a2
							WHERE
								a2.my_uid = #{followUid}
							AND a2.follow_uid = #{myUid}
							AND a2.gid = #{gid}
						) b1
					WHERE
						(b1.my_uid = qf.uid AND b1.follow_uid = qf.follow_uid)
					OR  (b1.follow_uid = qf.uid AND b1.my_uid = qf.follow_uid)
				)
			) a1,
			qx_zone_answer AS qa,
			qx_zone AS qz
		WHERE
			a1.gid = qa.gid
		AND qa.zone_type = qz.zone_type
		AND a1.num = qz.zone
	</insert>
	
	<!-- h5匹配度单独存储 -->
	<insert id="addNewMatchH5">
		INSERT INTO `qx_match_h5`(
			`gid`,
			`my_unionid`,
			`my_uid`,
			`my_img`,
			`my_name`,
			`follow_unionid`,
			`follow_uid`,
			`follow_img`,
			`follow_name`,
			`match_result`,
			`zone_content`,
			`title`,
			`create_time`
		)SELECT
			a1.gid,
			a1.my_unionid,
			a1.my_uid,
			a1.my_img,
			a1.my_name,
			a1.follow_unionid,
			a1.follow_uid,
			a1.follow_img,
			a1.follow_name,
			a1.match_result,
			qz.zone_content,
			qz.title,
			NOW()AS "create_time"
		FROM
			(
				SELECT
					#{gid} AS "gid",
					u1.unionid AS "my_unionid",
					u1.uid AS "my_uid",
					u1.headimgurl AS "my_img",
					u1.`nickname` AS "my_name",
					u2.unionid AS "follow_unionid",
					u2.uid AS "follow_uid",
					u2.headimgurl AS "follow_img",
					u2.nickname AS "follow_name",
					#{matchResult} AS 'match_result',
					ROUND(#{matchResult}, 1)AS 'num'
				FROM
					system_user AS u1 ,system_user AS u2 
				WHERE
					u1.uid = #{myUid}
				AND u2.uid = #{followUid}
			)a1,
			qx_zone_answer AS qa,
			qx_zone AS qz
		WHERE
			a1.gid = qa.gid
		AND qa.zone_type = qz.zone_type
		AND a1.num = qz.zone
	</insert>
	
	<update id="update">
		
	</update>
	
	<update id="delete">
		
	</update>
	
	<select id="findIsNewFollow" resultType="java.lang.Integer">
		SELECT
			COUNT(a1.follow_uid)
		FROM
			(
				SELECT
					t2.uid,
					t2.follow_uid,
					t2.gid
				FROM
					(
						SELECT DISTINCT
							qa2.gid
						FROM
							qx_history_answer AS qa2
						WHERE
							qa2.gid = #{gid}
						AND qa2.uid = #{uid}
					) t1,
					(
						SELECT
							qf.uid,
							qf.follow_uid,
							qa.gid
						FROM
							qx_follow AS qf,
							qx_history_answer AS qa
						WHERE
							qf.uid = #{uid}
						AND qf.follow_uid = qa.uid
						AND qa.gid = #{gid}
						AND qf.del_flag = '0'
						GROUP BY
							qf.uid,
							qf.follow_uid
					) t2
				WHERE
					t1.gid = t2.gid
			) a1
		WHERE
			NOT EXISTS (
				SELECT
					q1.gid,
					q1.my_uid,
					q1.follow_uid
				FROM
					(
						SELECT
							qm.gid,
							qm.my_uid,
							qm.`follow_uid` AS "follow_uid"
						FROM
							`qx_match` AS qm
						WHERE
							qm.gid = #{gid}
						AND qm.my_uid = #{uid}
						AND qm.del_flag = '0'
					UNION
						SELECT
							qm.gid,
							qm.follow_uid AS "my_uid",
							qm.`my_uid` AS "follow_uid"
						FROM
							`qx_match` AS qm
						WHERE
							qm.gid = #{gid}
						AND qm.follow_uid = #{uid}
						AND qm.del_flag = '0'
					) q1
				WHERE
					q1.gid = a1.gid
				AND q1.my_uid = a1.uid
				AND q1.follow_uid = a1.follow_uid
			)
	</select>
	
	<insert id="addNewRankData">
		INSERT INTO `qx_match`(
				`gid`,
				`my_unionid`,
				`my_uid`,
				`my_img`,
				`my_name`,
				`follow_unionid`,
				`follow_uid`,
				`follow_img`,
				`follow_name`,
				`match_result`,
				`zone_content`,
				`title`,
				`create_time`
			)
			SELECT
				#{gid} AS "gid",
				d1.my_unionid,
				d1.myuid AS "my_uid",
				d1.my_img,
				d1.my_name,
				d1.follow_unionid,
				d1.fuid AS "follow_uid",
				d1.follow_img,
				d1.follow_name,
				d1.pct AS "match_result",
				d2.zone_content,
				d2.title,
			  NOW() AS "create_time"
			FROM
				(
					SELECT
						c1.my_unionid,
						c1.myuid,
						c1.my_img,
						c1.my_name,
						c1.follow_unionid,
						c1.fuid,
						c1.follow_img,
						c1.follow_name,
						ROUND((c2.baseNum * 2 - c1.num)/ c2.baseNum,2)AS pct,
						ROUND((c2.baseNum * 2 - c1.num)/ c2.baseNum,1)AS vs
					FROM
						(
							SELECT
								b3.myuid,
								b3.my_unionid,
								b3.my_img,
								b3.my_name,
								b3.fuid,
								su.unionid AS "follow_unionid",
								b3.follow_img,
								b3.follow_name,
								b3.num
							FROM
								(
									SELECT
										b2.uid AS "myuid",
										b2.my_unionid,
										b2.my_img,
										b2.my_name,
										b2.fuid,
										b2.follow_img,
										b2.follow_name,
										COUNT(b2.fuid)AS "num"
									FROM
										(
											SELECT
												b1.uid,
												b1.my_unionid,
												b1.my_img,
												b1.my_name,
												b1.fuid,
												b1.follow_img,
												b1.follow_name,
												count(b1.answer)AS "vs_num"
											FROM
												(
													SELECT
														a2.uid,
														a2.my_unionid,
														a2.my_img,
														a2.my_name,
														a2.fuid,
														a1.qid,
														a1.answer,
														a2.follow_img,
														a2.follow_name
													FROM
														qx_history_answer AS a1,
														(
															SELECT
																vs.uid,
																vs.unionid AS "my_unionid",
																vs.img AS "my_img",
																vs.`name` AS "my_name",
																vs.fuid,
																vs.follow_img,
																vs.follow_name
															FROM
																(
																	SELECT DISTINCT
																		qf.uid,
																		qf.unionid,
																		qf.img,
																		qf.`name`,
																		ha.uid AS "fuid",
																		qf.follow_img,
																		qf.follow_name,
																		ha.gid AS "gid"
																	FROM
																		qx_follow AS qf,
																		qx_history_answer AS ha
																	WHERE
																		qf.uid = #{uid}
																	AND qf.follow_uid = ha.uid
																	AND ha.gid = #{gid}
																	AND qf.del_flag = '0'
																)vs
															WHERE
																NOT EXISTS(
																	SELECT
																		qm.my_uid,
																		qm.follow_uid
																	FROM
																		qx_match AS qm
																	WHERE
																		qm.gid = vs.gid
																	AND qm.my_uid = vs.uid
																	AND qm.del_flag = '0'
																	AND qm.follow_uid = vs.fuid
																)
														)a2
													WHERE
														a1.uid = a2.uid
													AND a1.gid = #{gid}
													AND a1.uid = a2.uid
													UNION ALL
														SELECT
															vs.uid,
															vs.unionid AS "my_unionid",
															vs.img AS "my_img",
															vs.`name` AS "my_name",
															vs.fuid,
															vs.qid,
															vs.answer,
															vs.follow_img,
															vs.follow_name
														FROM
															(
																SELECT
																	qf.uid,
																	qf.unionid,
																	qf.img,
																	qf.`name`,
																	ha.uid AS "fuid",
																	qf.follow_img,
																	qf.follow_name,
																	ha.gid AS "gid",
																	ha.qid,
																	ha.answer
																FROM
																	qx_follow AS qf,
																	qx_history_answer AS ha
																WHERE
																	qf.uid = #{uid}
																AND qf.follow_uid = ha.uid
																AND ha.gid = #{gid}
																AND qf.del_flag = '0'
															)vs
														WHERE
															NOT EXISTS(
																SELECT
																	qm.my_uid,
																	qm.follow_uid
																FROM
																	qx_match AS qm
																WHERE
																	qm.gid = vs.gid
																AND qm.my_uid = vs.uid
																AND qm.del_flag = '0'
																AND qm.follow_uid = vs.fuid
															)
												)b1
											GROUP BY
												b1.fuid,
												b1.qid,
												b1.answer
											ORDER BY
												b1.fuid
										)b2
									GROUP BY
										b2.fuid
								)b3,
								system_user AS su
							WHERE
								b3.fuid = su.uid
							AND su.del_flag = '0'
						)c1,
						(
							SELECT
								COUNT('x')AS "baseNum"
							FROM
								qx_questions AS qq
							WHERE
								qq.gid = #{gid}
						)c2
				)d1
			LEFT JOIN(
				SELECT
					a1.zone,
					a1.title,
					a1.zone_content
				FROM
					qx_zone AS a1,
					qx_zone_answer AS a2
				WHERE
					a2.gid = #{gid}
				AND a1.zone_type = a2.zone_type
			)d2 ON d1.vs = d2.zone
			WHERE
				NOT EXISTS (
					SELECT
						'x'
					FROM
						qx_match AS qm
					WHERE
						qm.gid = #{gid}
					AND qm.my_uid = d1.fuid
					AND qm.del_flag = '0'
					AND qm.follow_uid = d1.myuid
				)
			ORDER BY
				d1.pct DESC
	</insert>
	
	<select id="findRankByFootprintList" resultType="com.innovate.cms.modules.data.entity.FootprintRankToJson">
		SELECT
				a1.followUid AS "followUid",
				a1.followName AS "followName",
				a1.followImg AS "followImg",
				a1.matchResult AS "matchResult",
				a1.zoneContent AS "zoneContent"
			FROM
				(
						SELECT
							`qmid` AS "qmid",
							`follow_uid` AS "followUid",
							`follow_img` AS "followImg",
							`follow_name` AS "followName",
							`match_result` AS "matchResult",
							`title` AS "zoneContent"
						FROM
							`qx_match` AS qm
						WHERE
							qm.gid = #{gid}
						AND qm.my_uid = #{uid}
						AND qm.del_flag = '0'
					UNION
						SELECT
							`qmid` AS "qmid",
							`my_uid` AS "followUid",
							`my_img` AS "followImg",
							`my_name` AS "followName",
							`match_result` AS "matchResult",
							`title` AS "zoneContent"
						FROM
							`qx_match` AS qm
						WHERE
							qm.gid = #{gid}
						AND qm.follow_uid = #{uid}
						AND qm.del_flag = '0'
				)a1
			ORDER BY
				a1.matchResult DESC
			LIMIT 0,50
	</select>
	
	<select id="findRankByTemplet5List" resultType="com.innovate.cms.modules.data.entity.TempletRankToJson">
		SELECT
				a1.followUid AS "followUid",
				a1.followName AS "followName",
				a1.followImg AS "followImg",
				a1.matchResult AS "matchResult",
				a1.zoneContent AS "zoneContent"
			FROM
				(
						SELECT
							`qmid` AS "qmid",
							`follow_uid` AS "followUid",
							`follow_img` AS "followImg",
							`follow_name` AS "followName",
							`match_result` AS "matchResult",
							`zone_content` AS "zoneContent"
						FROM
							`qx_match` AS qm
						WHERE
							qm.gid = #{gid}
						AND qm.my_uid = #{uid}
						AND qm.del_flag = '0'
						AND qm.visible=0
					UNION
						SELECT
							`qmid` AS "qmid",
							`my_uid` AS "followUid",
							`my_img` AS "followImg",
							`my_name` AS "followName",
							`match_result` AS "matchResult",
							`zone_content` AS "zoneContent"
						FROM
							`qx_match` AS qm
						WHERE
							qm.gid = #{gid}
						AND qm.follow_uid = #{uid}
						AND qm.del_flag = '0'
						AND qm.visible=0
				)a1
			ORDER BY
				a1.matchResult DESC
			LIMIT 0,50
	</select>
	<select id="findRankByTemplet5ListH5" resultType="com.innovate.cms.modules.data.entity.TempletRankToJson">
		SELECT
				a1.followUid AS "followUid",
				a1.followName AS "followName",
				a1.followImg AS "followImg",
				a1.matchResult AS "matchResult",
				a1.zoneContent AS "zoneContent"
			FROM
				(
						SELECT
							`qmid` AS "qmid",
							`follow_uid` AS "followUid",
							`follow_img` AS "followImg",
							`follow_name` AS "followName",
							`match_result` AS "matchResult",
							`zone_content` AS "zoneContent"
						FROM
							`qx_match_h5` AS qm
						WHERE
							qm.gid = #{gid}
						AND qm.my_uid = #{uid}
						AND qm.del_flag = '0'
					UNION
						SELECT
							`qmid` AS "qmid",
							`my_uid` AS "followUid",
							`my_img` AS "followImg",
							`my_name` AS "followName",
							`match_result` AS "matchResult",
							`zone_content` AS "zoneContent"
						FROM
							`qx_match_h5` AS qm
						WHERE
							qm.gid = #{gid}
						AND qm.follow_uid = #{uid}
						AND qm.del_flag = '0'
				)a1
			ORDER BY
				a1.matchResult DESC
			LIMIT 0,50
	</select>
	
	<select id="findRankByTemplet5ListTimeDesc" resultType="com.innovate.cms.modules.data.entity.TempletRankToJson">
		SELECT
				a1.followUid AS "followUid",
				a1.followName AS "followName",
				a1.followImg AS "followImg",
				a1.matchResult AS "matchResult",
				a1.zoneContent AS "zoneContent"
			FROM
				(
						SELECT
							`qmid` AS "qmid",
							`follow_uid` AS "followUid",
							`follow_img` AS "followImg",
							`follow_name` AS "followName",
							`match_result` AS "matchResult",
							`zone_content` AS "zoneContent",
							create_time AS "createTime"
						FROM
							`qx_match` AS qm
						WHERE
							qm.gid = #{gid}
						AND qm.my_uid = #{uid}
						AND qm.del_flag = '0'
					UNION
						SELECT
							`qmid` AS "qmid",
							`my_uid` AS "followUid",
							`my_img` AS "followImg",
							`my_name` AS "followName",
							`match_result` AS "matchResult",
							`zone_content` AS "zoneContent",
							create_time AS "createTime"
						FROM
							`qx_match` AS qm
						WHERE
							qm.gid = #{gid}
						AND qm.follow_uid = #{uid}
						AND qm.del_flag = '0'
				)a1
			ORDER BY
				a1.createTime DESC
			LIMIT 0,50
	</select>
	<select id="findRankByTemplet5ListTimeDescH5" resultType="com.innovate.cms.modules.data.entity.TempletRankToJson">
		SELECT
				a1.followUid AS "followUid",
				a1.followName AS "followName",
				a1.followImg AS "followImg",
				a1.matchResult AS "matchResult",
				a1.zoneContent AS "zoneContent"
			FROM
				(
						SELECT
							`qmid` AS "qmid",
							`follow_uid` AS "followUid",
							`follow_img` AS "followImg",
							`follow_name` AS "followName",
							`match_result` AS "matchResult",
							`zone_content` AS "zoneContent",
							create_time AS "createTime"
						FROM
							`qx_match_h5` AS qm
						WHERE
							qm.gid = #{gid}
						AND qm.my_uid = #{uid}
						AND qm.del_flag = '0'
					UNION
						SELECT
							`qmid` AS "qmid",
							`my_uid` AS "followUid",
							`my_img` AS "followImg",
							`my_name` AS "followName",
							`match_result` AS "matchResult",
							`zone_content` AS "zoneContent",
							create_time AS "createTime"
						FROM
							`qx_match_h5` AS qm
						WHERE
							qm.gid = #{gid}
						AND qm.follow_uid = #{uid}
						AND qm.del_flag = '0'
				)a1
			ORDER BY
				a1.createTime DESC
			LIMIT 0,50
	</select>
	<select id="findRankByTemplet4List" resultType="com.innovate.cms.modules.data.entity.Templet4RankToJson">
		SELECT
			qf.follow_uid AS "followUid",
			qf.follow_name AS "followName",
			qf.follow_img AS "followImg",
			qr.text2 AS "result"
		FROM
			qx_follow AS qf,
			qx_history AS qh,
			qx_questions_results AS qr
		WHERE
			qf.uid = #{uid}
		AND qh.gid = #{gid}
		AND qr.gid = qh.gid
		AND qf.follow_uid = qh.uid
		AND qr.results_tag = qh.results_tag
		AND qh.del_flag = '0'
		AND qf.del_flag = '0'
		AND qh.visible=0
		ORDER BY qh.create_time DESC
		LIMIT 0,50
	</select>
	
	<select id="findRankByTemplet4h5" resultType="com.innovate.cms.modules.data.entity.Templet4RankToJson">
	
		SELECT
            qm.follow_uid AS "followUid",
            qm.follow_name AS "followName",
            qm.follow_img AS "followImg",
            qm.title AS "result"
        FROM
            qx_match_h5 AS qm
        WHERE
            qm.my_uid = #{uid}
        AND qm.gid = #{gid}  ORDER BY qm.update_time DESC
	
	</select>
	
	<select id="findRankByTemplet4h5Extend" resultType="com.innovate.cms.modules.data.entity.Templet4RankExtendToJson">
	
		SELECT
			qm.follow_uid AS "followUid",
			qm.follow_name AS "followName",
			qm.follow_img AS "followImg",
			qm.title AS "result",
			c.rankTitle as "rankTitle"
		FROM
			qx_match_h5 AS qm,
			market_group_configue AS c
		WHERE
			qm.my_uid = #{uid}
		AND qm.gid = #{gid}
		AND qm.gid = c.gid  ORDER BY qm.update_time DESC
	
	</select>
	
	<select id="findRankByTemplet4Listbak" resultType="com.innovate.cms.modules.data.entity.Templet4RankToJson">
		SELECT
			qf.follow_uid AS "followUid",
			qf.follow_name AS "followName",
			qf.follow_img AS "followImg",
			qh.results AS "result"
		FROM
			qx_follow AS qf,
			qx_history AS qh
		WHERE
			qf.uid = #{uid}
		AND qh.gid = #{gid}
		AND qf.follow_uid = qh.uid
		AND qh.del_flag = '0'
		AND qf.del_flag = '0'
		ORDER BY qh.create_time DESC
		LIMIT 0,50
	</select>
	
	<update id="updateMatchData">
		UPDATE qx_match
		SET my_name = (
		CASE my_uid
		WHEN #{uid} THEN
		#{nickname}
		ELSE
		my_name
		END
		),
		my_img = (
		CASE my_uid
		WHEN #{uid} THEN
		#{headimgurl}
		ELSE
		my_img
		END
		),
		follow_name = (
		CASE follow_uid
		WHEN #{uid} THEN
		#{nickname}
		ELSE
		follow_name
		END
		),
		follow_img = (
		CASE follow_uid
		WHEN #{uid} THEN
		#{headimgurl}
		ELSE
		follow_img
		END
		)
		WHERE
		del_flag = "0"
		AND (my_uid = #{uid}
		OR follow_uid = #{uid})
	</update>
	
	<update id="setVisible">
		UPDATE qx_match
		SET visible = #{visible}
		WHERE
			(
				my_uid = #{uid}
				OR follow_uid = #{uid}
			)
		AND gid = #{gid}
	</update>
</mapper>