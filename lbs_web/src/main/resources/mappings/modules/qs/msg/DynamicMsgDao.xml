<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.innovate.cms.modules.qs.dao.msg.DynamicMsgDao">

	<select id="get" resultType="DynamicMsg">

	</select>

	<select id="findList" resultType="DynamicMsg">

	</select>


	<insert id="insert">


	</insert>

	<insert id="save" useGeneratedKeys="true" keyProperty="mid">
		INSERT INTO dynamic_msg (
		uid,
		user_name,
		headimgurl,
		msg_type,
		anonymity,
		title,
		description,
		business_address,
		business_name,
		price,
		reward,
		requirements,
		pics,
		location,
		geo_id
		) SELECT
		u.uid,
		u.nickname,
		u.headimgurl,
		#{msgType},
		#{anonymity},
		#{title},
		#{description},
		#{businessAddress},
		#{businessName},
		#{price},
		#{reward},
		#{requirements},
		#{pics},
		#{location},
		#{geoId}
		FROM
		system_user AS u
		WHERE
		u.uid = #{uid}
	</insert>

	<select id="lastesMsg" resultType="com.innovate.cms.modules.qs.entity.msg.DynamicMsgForService">
		SELECT
		m.mid,
		m.uid,
		m.user_name ,
		m.headimgurl,
		m.msg_type ,
		m.anonymity,
		m.title,
		m.description,
		m.business_address ,
		m.business_name ,
		m.price,
		m.reward,
		m.requirements,
		m.pics,
		m.publish_time,
		m.location,
		m.coord_type ,
		s.prise_num ,
		s.comment_num,
		s.share_num 
		FROM
		dynamic_msg AS m,
		dynamic_msg_statistic AS s
		WHERE
		m.mid = s.mid
		ORDER BY
		m.mid desc
		LIMIT 20
	</select>
	
	<select id="virtualMsg" resultType="com.innovate.cms.modules.qs.entity.msg.DynamicMsgForService">
		SELECT
			m.mid,
			m.uid,
			m.user_name,
			m.headimgurl,
			m.msg_type,
			m.anonymity,
			m.title,
			m.description,
			m.business_address,
			m.business_name,
			m.price,
			m.reward,
			m.requirements,
			m.pics,
			m.publish_time,
			m.location,
			m.coord_type,
			s.prise_num,
			s.comment_num
		FROM
			(
				SELECT
					*
				FROM
					dynamic_msg
				WHERE
					mid >= (
						(
							SELECT
								MAX(mid)
							FROM
								dynamic_msg
						) - (
							SELECT
								MIN(mid)
							FROM
								dynamic_msg
						)
					) * RAND() + (
						SELECT
							MIN(mid)
						FROM
							dynamic_msg
					)
				AND is_virtual = 1
				LIMIT 20
			) AS m,
			dynamic_msg_statistic AS s
		WHERE
			m.mid = s.mid
		ORDER BY
					m.mid DESC
	</select>
	<select id="getMsgByMid" resultType="com.innovate.cms.modules.qs.entity.msg.DynamicMsgForService">
		SELECT
		m.mid,
		m.uid,
		m.user_name ,
		m.headimgurl,
		m.msg_type ,
		m.anonymity,
		m.title,
		m.description,
		m.business_address ,
		m.business_name ,
		m.price,
		m.reward,
		m.requirements,
		m.pics,
		m.publish_time,
		m.location,
		m.coord_type ,
		s.prise_num ,
		s.comment_num,
		s.share_num 
		FROM
		dynamic_msg AS m,
		dynamic_msg_statistic AS s
		WHERE
		m.mid = #{mid} AND 
		m.mid = s.mid
		
	</select>
	<select id="nearMsg" resultType="com.innovate.cms.modules.qs.entity.msg.DynamicMsgForService">
		SELECT
		m.mid,
		m.uid,
		m.user_name ,
		m.headimgurl,
		m.msg_type ,
		m.anonymity,
		m.title,
		m.description,
		m.business_address,
		m.business_name ,
		m.price,
		m.reward,
		m.requirements,
		m.pics,
		m.publish_time ,
		m.location,
		m.coord_type ,
		s.prise_num ,
		s.comment_num,
		s.share_num 
		FROM
		dynamic_msg AS m,
		dynamic_msg_statistic AS s
		WHERE
		m.mid = s.mid and
		m.mid in
		<foreach item="item" index="index" collection="array" open="(" separator="," close=")">
			#{item}
		</foreach>
		ORDER BY
		m.mid desc
	</select>
	


	
	<select id="userLatestMsg" resultType="com.innovate.cms.modules.qs.entity.msg.DynamicMsgForService">
		SELECT
			m.mid,
			m.uid,
			m.user_name,
			m.headimgurl,
			m.msg_type,
			m.anonymity,
			m.title,
			m.description,
			m.business_address,
			m.business_name,
			m.price,
			m.reward,
			m.requirements,
			m.pics,
			m.publish_time,
			m.location,
			m.coord_type,
			s.prise_num,
			s.comment_num,
		s.share_num 
		FROM
			dynamic_msg AS m,
			dynamic_msg_statistic AS s
		WHERE
			m.uid = #{uid} AND 
			m.mid = s.mid
		
		order by m.mid desc LIMIT 20
	</select>
	
	<select id="userUpLatestMsg" resultType="com.innovate.cms.modules.qs.entity.msg.DynamicMsgForService">
			SELECT
			m.mid,
			m.uid,
			m.user_name,
			m.headimgurl,
			m.msg_type,
			m.anonymity,
			m.title,
			m.description,
			m.business_address,
			m.business_name,
			m.price,
			m.reward,
			m.requirements,
			m.pics,
			m.publish_time,
			m.location,
			m.coord_type,
			s.prise_num,
			s.comment_num,
		s.share_num 
		FROM
			dynamic_msg AS m,
			dynamic_msg_statistic AS s
		WHERE
			m.uid = #{uid} AND 
			m.mid = s.mid AND 
			m.mid &lt; #{mid}
		order by m.mid desc LIMIT 20
	</select>
	
	<select id="userDownLatestMsg" resultType="com.innovate.cms.modules.qs.entity.msg.DynamicMsgForService">
			SELECT
			m.mid,
			m.uid,
			m.user_name,
			m.headimgurl,
			m.msg_type,
			m.anonymity,
			m.title,
			m.description,
			m.business_address,
			m.business_name,
			m.price,
			m.reward,
			m.requirements,
			m.pics,
			m.publish_time,
			m.location,
			m.coord_type,
			s.prise_num,
			s.comment_num,
		s.share_num 
		FROM
			dynamic_msg AS m,
			dynamic_msg_statistic AS s
		WHERE
			m.uid = #{uid} AND 
			m.mid = s.mid AND 
			m.mid &gt; #{mid}
		order by m.mid desc LIMIT 20
	</select>
	
	<select id="friendLatestMsg" resultType="com.innovate.cms.modules.qs.entity.msg.DynamicMsgForService">
		SELECT
			m.mid,
			m.uid,
			m.user_name,
			m.headimgurl,
			m.msg_type,
			m.anonymity,
			m.title,
			m.description,
			m.business_address,
			m.business_name,
			m.price,
			m.reward,
			m.requirements,
			m.pics,
			m.publish_time,
			m.location,
			m.coord_type,
			s.prise_num,
			s.comment_num,
		s.share_num 
		FROM
			dynamic_msg AS m,
			dynamic_msg_statistic AS s,
			qx_follow AS f
		WHERE
			f.follow_uid = #{uid}
			AND f.del_flag = 0
		AND m.uid = f.uid
		
		AND m.mid = s.mid
		ORDER BY
			m.mid DESC
		LIMIT 20
	</select>
	
	<select id="friendUpLatestMsg" resultType="com.innovate.cms.modules.qs.entity.msg.DynamicMsgForService">
		SELECT
			m.mid,
			m.uid,
			m.user_name,
			m.headimgurl,
			m.msg_type,
			m.anonymity,
			m.title,
			m.description,
			m.business_address,
			m.business_name,
			m.price,
			m.reward,
			m.requirements,
			m.pics,
			m.publish_time,
			m.location,
			m.coord_type,
			s.prise_num,
			s.comment_num,
		s.share_num 
		FROM
			dynamic_msg AS m,
			dynamic_msg_statistic AS s,
			qx_follow AS f
		WHERE
			f.follow_uid = #{uid}
			AND f.del_flag = 0
		AND m.uid = f.uid
		AND m.mid &lt; #{mid}
		AND m.mid = s.mid
		ORDER BY
			m.mid DESC
		LIMIT 20
	</select>
	
	<select id="friendDownLatestMsg" resultType="com.innovate.cms.modules.qs.entity.msg.DynamicMsgForService">
				SELECT
			m.mid,
			m.uid,
			m.user_name,
			m.headimgurl,
			m.msg_type,
			m.anonymity,
			m.title,
			m.description,
			m.business_address,
			m.business_name,
			m.price,
			m.reward,
			m.requirements,
			m.pics,
			m.publish_time,
			m.location,
			m.coord_type,
			s.prise_num,
			s.comment_num,
		s.share_num 
		FROM
			dynamic_msg AS m,
			dynamic_msg_statistic AS s,
			qx_follow AS f
		WHERE
			f.follow_uid = #{uid}
		AND f.del_flag = 0
		AND m.uid = f.uid
		AND m.mid &gt; #{mid}
		AND m.mid = s.mid
		ORDER BY
			m.mid DESC
		LIMIT 20
	</select>
	
	<select id="getMsgNum" resultType="int">
		SELECT
			COUNT(1)
		FROM
			dynamic_msg
		WHERE
			uid = #{uid}
	</select>
	
	<select id="userPriseList" resultType="int">
		SELECT
			mid
		FROM
			dynamic_msg_prise
		WHERE
			uid = #{uid}
	</select>


	<update id="addPriseNum">
		UPDATE dynamic_msg_statistic
		SET prise_num = prise_num + 1
		WHERE
		mid = #{mid}
	</update>
	<update id="subPriseNum">
		UPDATE dynamic_msg_statistic
		SET prise_num = prise_num - 1
		WHERE
		mid = #{mid}
	</update>
	<update id="addShareNum">
		UPDATE dynamic_msg_statistic
		SET share_num = share_num + 1
		WHERE
			mid = #{mid}
	</update>

	<insert id="saveQxTagUser">
		INSERT IGNORE INTO `qx_tag_user` (
		`uid`,
		`tagId`,
		`tagName`
		)
		VALUES
		(
		#{uid},
		#{tagId},
		#{tagName}
		) ON DUPLICATE KEY UPDATE nums=nums+1

	</insert>
	






</mapper>